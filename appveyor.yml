version: Build {build} ({branch} branch)

branches:
  only:
    - appveyor

platform: x64

matrix:
  fast_finish: true

configuration:
  - Release
  - Debug

skip_tags: true

image: Visual Studio 2017

shallow_clone: true
clone_depth: 5

cache:
  - C:\Tools\downloads
  - C:\OSGeo4W64

environment:
  DOWNLOAD_DIR: C:\Tools\downloads
  OSGEO4W_ROOT: C:\OSGeo4W64
  PREFIX_PATH: '%OSGEO4W_ROOT%'
  TARGET_OS: windows

init:
  - mkdir %DOWNLOAD_DIR%
  - curl -fsS -o %DOWNLOAD_DIR%\osgeo4w-setup-x86_64.exe http://download.osgeo.org/osgeo4w/osgeo4w-setup-x86_64.exe

install:
  - echo . | %DOWNLOAD_DIR%\osgeo4w-setup-x86_64.exe --autoaccept --no-shortcuts --no-startmenu --no-desktop --quiet-mode --arch x86_64 --download --advanced --site http://download.osgeo.org/osgeo4w --root %OSGEO4W_ROOT% --packages pdal

build_script:
  - set ARCH=%PLATFORM%
  - set BUILD_TYPE=%CONFIGURATION%
  - echo %PREFIX_PATH%
  - dir %OSGEO4W_ROOT%\lib\pdal\cmake
  - call make.bat
  - echo "Built %PLATFORM%-%TARGET_OS%-%CONFIGURATION%"

test_script:
  - set GDAL_DATA=%OSGEO4W_ROOT%\share\gdal
  - set PROJ_LIB=%OSGEO4W_ROOT%\share\proj
  - if exist "build\%ARCH%-%TARGET_OS%\test_pdalc.exe" "build\%ARCH%-%TARGET_OS%\test_pdalc.exe"
  - if exist "build\%ARCH%-%TARGET_OS%\test_pdalcd.exe" "build\%ARCH%-%TARGET_OS%\test_pdalcd.exe"

after_test:
  - if exist "build\%ARCH%-%TARGET_OS%\test_pdalc.exe" erase "build\%ARCH%-%TARGET_OS%\test_pdalc.exe"
  - if exist "build\%ARCH%-%TARGET_OS%\test_pdalcd.exe" erase "build\%ARCH%-%TARGET_OS%\test_pdalcd.exe"

